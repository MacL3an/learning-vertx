<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Service status</title>

    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js" type="text/javascript"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/0.9.2/backbone-min.js" type="text/javascript"></script>

</head>
<body>
<div id="serviceapp" role="main">
    <div class="page-header">
        <div class="row">
            <div class="col-md-12">
                <h1>Services</h1>
                <button class="pull-left btn btn-primary" data-action="add" data-toggle="modal"
                        data-target="#newService">
                    <span class="glyphicon glyphicon-plus"></span> Add a new service
                </button>
                <table class="table table-striped">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>Address</th>
                        <th>Status</th>
                        <th>Last check</th>                        
                        <th>Delete</th>
                    </tr>
                    </thead>
                    <tbody id="service-list">
                    <!-- filled using Ajax -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
  
    <div class="modal fade" id="newService" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="dialog">
          <div class="modal-content">
              <div class="modal-header">
                  <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                  <h4 class="modal-title" id="newServiceTitle">Add a new service</h4>
              </div>
              <div class="modal-body">
                  <form>
                      <div class="form-group">
                          <label for="service-name" class="control-label">Name:</label>
                          <input type="text" class="form-control" id="service-name">
                      </div>
                      <div class="form-group">
                          <label for="service-url" class="control-label">URL:</label>
                          <input type="text" class="form-control" id="service-url">
                      </div>
                  </form>
              </div>
              <div class="modal-footer">
                  <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                  <button type="button" id="addButton" class="btn btn-primary">Save</button>
              </div>
          </div>
      </div>
  </div>
  
</div>
 
  
  <script type="text/template" id="item-template">
      <td><%- name %></td>
      <td><%- url %></td>
      <%- url %><td><%- status %></td>
      <td><%- lastCheck %></td>
      <td>
        <button class='btn btn-danger btn-sm delete-button' data-id=<%- id %>>
          <span class='glyphicon glyphicon-minus'></span>
        </button>
      </td>
  </script>

  <script type="text/javascript">
    var Service = Backbone.Model.extend({
        defaults: {
            id: undefined,
            name: "",
            url: "",
            status: "",
            lastCheck: "",
        },
        
        //url: "../services/",
        //idAttribute: "id"
    });

    var ServiceCollection = Backbone.Collection.extend({
      model: Service,
      url: "../services",
    });

    var AppView = Backbone.View.extend({
      el: '#serviceapp',
      events: {
        'click #addButton': "newService",
      },      
      initialize: function() {
        collection.on('add', this.addOne, this);
        collection.on('reset', this.addAll, this); //called on collection.fetch()
        collection.fetch();
      },
      addOne: function(service){
        var view = new ServiceView({model: service});
        $('#service-list').append(view.render().el);
      },
      addAll: function(){
        this.$('#service-list').html(''); // clean the todo list
        collection.each(this.addOne, this);
      },
      newService: function() {
        var newName = $("#service-name").val();
        var newUrl = $("#service-url").val();
        collection.create({name: newName, url: newUrl});
        $('#newService').modal('toggle');
        $('#service-name').val("");
        $('#service-url').val("");        
      }
    });

    var ServiceView = Backbone.View.extend({
      tagName: 'tr',
      template: _.template($('#item-template').html()),
      initialize: function() {
        this.model.on('destroy', this.remove, this); // remove: Convenience Backbone's function for removing the view from the DOM.
      },      
      render: function() {
        this.$el.html(this.template(this.model.toJSON()));
        return this;
      },
      events: {
        'click .delete-button': 'deleteClicked',
      },
      deleteClicked: function(){
        console.log("deleting");
        this.model.destroy();
      }
    });

    var collection = new ServiceCollection();
    var appView = new AppView();
    setInterval(function() {
          collection.fetch();
        }, 5000);

  </script>
  
</body>
</html>